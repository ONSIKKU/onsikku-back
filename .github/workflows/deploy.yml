name: deploy.yml

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: JDK 21 설정
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Gradle 빌드
        run: ./gradlew build -x test

      - name: 도커 허브 로그인
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: 도커 이미지 빌드 및 푸시
        run: |
          # 이미지 태그에 깃허브 샤(SHA)를 붙여 버전을 관리하면 좋습니다.
          docker build -t ${{ secrets.DOCKER_USERNAME }}/onsikku-back:latest .
          docker push ${{ secrets.DOCKER_USERNAME }}/onsikku-back:latest

      - name: EC2에 .env 생성
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            mkdir -p ~/app
            echo "DB_URL=${{ secrets.DB_URL }}" > ~/app/.env
            echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> ~/app/.env
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> ~/app/.env
            echo "REDIS_HOST=${{ secrets.REDIS_HOST }}" >> ~/app/.env
            echo "REDIS_PORT=${{ secrets.REDIS_PORT }}" >> ~/app/.env
            echo "REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}" >> ~/app/.env
            echo "KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}" >> ~/app/.env
            echo "KAKAO_REDIRECT_URI=${{ secrets.KAKAO_REDIRECT_URI }}" >> ~/app/.env
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> ~/app/.env
            echo "JWT_EXPIRATION_TIME=${{ secrets.JWT_EXPIRATION_TIME }}" >> ~/app/.env
            echo "SPRING_PORT=${{ secrets.SPRING_PORT }}" >> ~/app/.env
            echo "JWT_REFRESH_EXPIRATION_TIME=${{ secrets.JWT_REFRESH_EXPIRATION_TIME }}" >> ~/app/.env
            echo "REDIS_REGISTRATION_TOKEN_EXPIRATION_MINUTES=${{ secrets.REDIS_REGISTRATION_TOKEN_EXPIRATION_MINUTES }}" >> ~/app/.env
            echo "AI_SERVER_BASE_URL=${{ secrets.AI_SERVER_BASE_URL }}" >> ~/app/.env
            chmod 600 ~/app/.env

      - name: EC2에서 컨테이너 교체 배포
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            # 1. 최신 이미지 가져오기
            docker pull ${{ secrets.DOCKER_USERNAME }}/onsikku-back:latest
            
            # 2. 기존 컨테이너 중지 및 삭제 (오류 무시)
            docker stop onsikku-server || true
            docker rm onsikku-server || true
            
            # 3. 사용하지 않는 도커 이미지 정리 (용량 확보)
            docker image prune -f
            
            # 4. 새 컨테이너 실행 (.env 파일의 환경변수 주입)
            # 호스트 포트는 기존처럼 SPRING_PORT(9131 예상)를 사용합니다.
            docker run -d \
              --name onsikku-server \
              -p ${{ secrets.SPRING_PORT }}:${{ secrets.SPRING_PORT }} \
              --env-file ~/app/.env \
              -e TZ=Asia/Seoul \
              ${{ secrets.DOCKER_USERNAME }}/onsikku-back:latest

      - name: 애플리케이션 Health Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            echo "애플리케이션 시작 대기 (20초)..."
            sleep 20
            HEALTH_URL="${{ secrets.HEALTH_CHECK_URL }}"
            MAX_ATTEMPTS=5
            ATTEMPTS=0
            while [ $ATTEMPTS -lt $MAX_ATTEMPTS ]; do
              ATTEMPTS=$((ATTEMPTS + 1))
              STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL)
              if [ "$STATUS_CODE" -eq 200 ]; then
                echo "Health Check 성공! (HTTP 200)"
                exit 0
              fi
              echo "실패 (HTTP $STATUS_CODE). 5초 후 재시도..."
              sleep 5
            done
            echo "Health Check 최종 실패!"
            exit 1