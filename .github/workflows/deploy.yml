name: deploy.yml

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: JDK 21 설정
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Gradle 빌드
        run: ./gradlew build -x test

      - name: 도커 허브 로그인
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: 도커 이미지 빌드 및 푸시
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/onsikku-back:latest .
          docker push ${{ secrets.DOCKER_USERNAME }}/onsikku-back:latest

      # docker-compose.yml 파일을 EC2로 전송
      - name: docker-compose.yml 전송
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: "docker-compose.yml"
          target: "~/app/"

      - name: EC2에 .env 생성
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            mkdir -p ~/app
            # 첫 줄은 > 로 생성, 나머지는 >> 로 추가 (작은따옴표로 특수문자 보호)
            echo "DB_URL='${{ secrets.DB_URL }}'" > ~/app/.env
            echo "DB_USERNAME='${{ secrets.DB_USERNAME }}'" >> ~/app/.env
            echo "DB_PASSWORD='${{ secrets.DB_PASSWORD }}'" >> ~/app/.env
            
            # Redis 관련 시크릿
            echo "REDIS_HOST='${{ secrets.REDIS_HOST }}'" >> ~/app/.env
            echo "REDIS_PORT='${{ secrets.REDIS_PORT }}'" >> ~/app/.env
            echo "REDIS_PASSWORD='${{ secrets.REDIS_PASSWORD }}'" >> ~/app/.env
            echo "REDIS_REGISTRATION_TOKEN_EXPIRATION_MINUTES='${{ secrets.REDIS_REGISTRATION_TOKEN_EXPIRATION_MINUTES }}'" >> ~/app/.env
            
            # 기타 인증 및 서비스 설정
            echo "KAKAO_CLIENT_ID='${{ secrets.KAKAO_CLIENT_ID }}'" >> ~/app/.env
            echo "KAKAO_REDIRECT_URI='${{ secrets.KAKAO_REDIRECT_URI }}'" >> ~/app/.env
            echo "JWT_SECRET='${{ secrets.JWT_SECRET }}'" >> ~/app/.env
            echo "JWT_EXPIRATION_TIME='${{ secrets.JWT_EXPIRATION_TIME }}'" >> ~/app/.env
            echo "JWT_REFRESH_EXPIRATION_TIME='${{ secrets.JWT_REFRESH_EXPIRATION_TIME }}'" >> ~/app/.env
            echo "SPRING_PORT='${{ secrets.SPRING_PORT }}'" >> ~/app/.env
            echo "AI_SERVER_BASE_URL='${{ secrets.AI_SERVER_BASE_URL }}'" >> ~/app/.env
            
            # Compose용 추가 변수
            echo "DOCKER_USERNAME='${{ secrets.DOCKER_USERNAME }}'" >> ~/app/.env
            
            chmod 600 ~/app/.env

      - name: EC2에서 Docker Compose 배포
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            cd ~/app
            # 최신 이미지를 불러오고 서비스를 갱신합니다.
            docker compose pull
            docker compose up -d
            # 사용하지 않는 옛날 이미지들 삭제
            docker image prune -f

      - name: 애플리케이션 Health Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            echo "애플리케이션 시작 대기 (20초)..."
            sleep 20
            HEALTH_URL="${{ secrets.HEALTH_CHECK_URL }}"
            MAX_ATTEMPTS=5
            ATTEMPTS=0
            while [ $ATTEMPTS -lt $MAX_ATTEMPTS ]; do
              ATTEMPTS=$((ATTEMPTS + 1))
              STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL)
              if [ "$STATUS_CODE" -eq 200 ]; then
                echo "Health Check 성공! (HTTP 200)"
                exit 0
              fi
              echo "실패 (HTTP $STATUS_CODE). 5초 후 재시도..."
              sleep 5
            done
            echo "Health Check 최종 실패!"
            exit 1