name: Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: JDK 21 설정
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle' # Gradle 캐시 활성화 (빌드 속도 향상)

      - name: Gradle 빌드 (jar 생성)
        # 빌드 결과물 이름을 app.jar로 고정하여 Dockerfile과 연동
        # build : Javadoc 생성, 소스 코드 패키징 등 모든 태스크를 다 수행
        # bootJar: 실행 가능한 JAR 파일 하나만 만듬
        # --no-daemon: CI 환경에 적합
        # -x test: 테스트를 배포 단계에서 제외한다면 추가 (테스트가 오래 걸릴 경우)
        run: ./gradlew clean bootJar -PjarName=app --no-daemon --stacktrace

      - name: 도커 허브 로그인
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: 도커 이미지 빌드 및 푸시
        run: |
          # 밖에서 빌드된 jar를 사용하므로 build-arg는 필요 없음
          docker build -t ${{ secrets.DOCKER_USERNAME }}/onsikku-back:latest .
          docker push ${{ secrets.DOCKER_USERNAME }}/onsikku-back:latest

      - name: 파일 전송 (Compose & .env 환경변수)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: "docker-compose.yml"
          target: "~/app/"

      - name: 서버에 .env 생성 및 실행 후 Health Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            set -e
            mkdir -p ~/app
            cd ~/app

            # .env 파일 생성 (Secrets를 안전하게 서버로 전달)
            cat > .env << EOF

            # DB 설정
            DB_URL=${{ secrets.DB_URL }}
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}

            # Redis 설정
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            REDIS_REGISTRATION_TOKEN_EXPIRATION_MINUTES=${{ secrets.REDIS_REGISTRATION_TOKEN_EXPIRATION_MINUTES }}

            # 기타 설정
            KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}
            KAKAO_REDIRECT_URI=${{ secrets.KAKAO_REDIRECT_URI }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_EXPIRATION_TIME=${{ secrets.JWT_EXPIRATION_TIME }}
            JWT_REFRESH_EXPIRATION_TIME=${{ secrets.JWT_REFRESH_EXPIRATION_TIME }}
            AI_SERVER_BASE_URL=${{ secrets.AI_SERVER_BASE_URL }}

            # Compose용
            DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
            EOF

            chmod 600 .env
            # 배포 실행
            docker compose pull -q
            docker compose up -d --remove-orphans
            # 안 쓰는 구형 이미지 정리 (용량 확보)
            docker image prune -f

            set -e

            echo "애플리케이션 시작 대기"
            sleep 20

            HEALTH_URL=${{ secrets.HEALTH_CHECK_URL }}

            MAX_ATTEMPTS=5
            ATTEMPTS=0

            while [ $ATTEMPTS -lt $MAX_ATTEMPTS ]; do
              ATTEMPTS=$((ATTEMPTS + 1))
              STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || true)

              if [ "$STATUS_CODE" -eq 200 ]; then
                echo "Health Check 성공! (HTTP 200) - $HEALTH_URL"
                exit 0
              fi

              echo "실패 (HTTP $STATUS_CODE) - $HEALTH_URL. 5초 후 재시도... ($ATTEMPTS/$MAX_ATTEMPTS)"
              sleep 5
            done

            echo "Health Check 최종 실패! - $HEALTH_URL"
            exit 1