name: Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: JDK 21 설정
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Gradle 빌드
        run: ./gradlew build -x test

      - name: 도커 허브 로그인
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: 도커 이미지 빌드 및 푸시
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/onsikku-back:latest .
          docker push ${{ secrets.DOCKER_USERNAME }}/onsikku-back:latest

      - name: docker-compose.yml 전송
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          source: "docker-compose.yml"
          target: "~/app/"

      - name: EC2에 .env 생성
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            set -e
            mkdir -p ~/app

            # .env 재생성 (따옴표 제거: 파서별 호환성 문제 방지)
            cat > ~/app/.env << 'EOF'
            # DB 설정
            DB_URL=${{ secrets.DB_URL }}
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}

            # Redis 설정
            REDIS_HOST=${{ secrets.REDIS_HOST }}
            REDIS_PORT=${{ secrets.REDIS_PORT }}
            REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
            REDIS_REGISTRATION_TOKEN_EXPIRATION_MINUTES=${{ secrets.REDIS_REGISTRATION_TOKEN_EXPIRATION_MINUTES }}

            # 기타 설정
            KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}
            KAKAO_REDIRECT_URI=${{ secrets.KAKAO_REDIRECT_URI }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_EXPIRATION_TIME=${{ secrets.JWT_EXPIRATION_TIME }}
            JWT_REFRESH_EXPIRATION_TIME=${{ secrets.JWT_REFRESH_EXPIRATION_TIME }}
            SPRING_PORT=${{ secrets.SPRING_PORT }}
            AI_SERVER_BASE_URL=${{ secrets.AI_SERVER_BASE_URL }}

            # Compose용
            DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
            EOF

            chmod 600 ~/app/.env

      - name: EC2에서 Docker Compose 배포
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            set -e
            cd ~/app

            docker compose -f docker-compose.yml pull
            docker compose -f docker-compose.yml up -d --remove-orphans

            docker image prune -f

      - name: 애플리케이션 Health Check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            set -e

            echo "애플리케이션 시작 대기 (20초)..."
            sleep 20

            HEALTH_URL=${{ secrets.HEALTH_CHECK_URL }}

            MAX_ATTEMPTS=5
            ATTEMPTS=0

            while [ $ATTEMPTS -lt $MAX_ATTEMPTS ]; do
              ATTEMPTS=$((ATTEMPTS + 1))
              STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || true)

              if [ "$STATUS_CODE" -eq 200 ]; then
                echo "Health Check 성공! (HTTP 200) - $HEALTH_URL"
                exit 0
              fi

              echo "실패 (HTTP $STATUS_CODE) - $HEALTH_URL. 5초 후 재시도... ($ATTEMPTS/$MAX_ATTEMPTS)"
              sleep 5
            done

            echo "Health Check 최종 실패! - $HEALTH_URL"
            exit 1