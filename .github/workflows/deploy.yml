name: deploy.yml

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: JDK 21 설정
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Gradle 빌드
        run: ./gradlew build -x test

      - name: JAR 전송
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          source: "build/libs/*.jar"
          target: "~/app/"
          strip_components: 2

      - name: EC2에 .env 생성
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" > ~/app/.env
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> ~/app/.env
            echo "REDIS_HOST=${{ secrets.REDIS_HOST }}" >> ~/app/.env
            echo "REDIS_PORT=${{ secrets.REDIS_PORT }}" >> ~/app/.env
            echo "REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}" >> ~/app/.env
            echo "KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}" >> ~/app/.env
            echo "KAKAO_REDIRECT_URI=${{ secrets.KAKAO_REDIRECT_URI }}" >> ~/app/.env
            echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> ~/app/.env
            echo "JWT_EXPIRATION_TIME=${{ secrets.JWT_EXPIRATION_TIME }}" >> ~/app/.env
            echo "SPRING_PORT=${{ secrets.SPRING_PORT }}" >> ~/app/.env
            echo "JWT_REFRESH_EXPIRATION_TIME=${{ secrets.JWT_REFRESH_EXPIRATION_TIME }}" >> ~/app/.env
            echo "REDIS_REGISTRATION_TOKEN_EXPIRATION_MINUTES=${{ secrets.REDIS_REGISTRATION_TOKEN_EXPIRATION_MINUTES }}" >> ~/app/.env
            echo "AI_SERVER_BASE_URL=${{ secrets.AI_SERVER_BASE_URL }}" >> ~/app/.env
          
            chmod 600 ~/app/.env

      - name: 원격 서버에서 기존 JAR 종료 후 실행
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            echo "이전 프로세스 종료 중..."
            PID=$(lsof -t -i :9131)
            if [ -n "$PID" ]; then
              echo "PID $PID 종료 시도"
              kill -9 $PID
              sleep 2
              if ps -p $PID > /dev/null; then
                echo "PID $PID 여전히 살아있음"
              else
                echo "PID $PID 종료 완료"
              fi
            else
              echo "실행 중인 프로세스 없음"
            fi
            
            echo ".env 환경변수 로드 후 애플리케이션 실행"
            export $(grep -v '^#' ~/app/.env | xargs) 
            nohup java -jar ~/app/onsikku-back-0.0.1-SNAPSHOT.jar --server.port=${{ secrets.SPRING_PORT }} > ~/app/app.log 2>&1 &
            

      - name: 애플리케이션 Health Check (배포 성공 확인)
        uses: appleboy/ssh-action@v1.0.3
        env:
          HEALTH_CHECK_URL: "https://api.onsikku.xyz/actuator/health" # <--- 여기에 정의
        with:
          host: ${{ secrets.SERVER_HOST }}
          port: ${{ secrets.SERVER_PORT }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_KEY }}
          script: |
            echo "애플리케이션 시작 대기 (20초)..."
              sleep 20
            
              # Health Check 시도 (최대 5회)
              HEALTH_URL="${{ env.HEALTH_CHECK_URL }}" # <--- 환경 변수로 사용
              MAX_ATTEMPTS=5
              ATTEMPTS=0
            
              while [ $ATTEMPTS -lt $MAX_ATTEMPTS ]; do
                ATTEMPTS=$((ATTEMPTS + 1))
                echo "Health Check 시도 $ATTEMPTS/$MAX_ATTEMPTS..."
            
                STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL)
            
                if [ "$STATUS_CODE" -eq 200 ]; then
                  echo "Health Check 성공! 애플리케이션이 정상적으로 구동되었습니다. (HTTP 200)"
                  exit 0
                fi
            
                if [ $ATTEMPTS -lt $MAX_ATTEMPTS ]; then
                  echo "Health Check 실패 (HTTP $STATUS_CODE). 5초 후 재시도합니다."
                  sleep 5
                fi
              done
            
              echo "Health Check 최종 실패. 배포 실패!"
              exit 1
